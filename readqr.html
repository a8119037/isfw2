<!-- QRコードリーダーのテスト -->
<!DOCTYPE html>
<html>
    <body>
        <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

        <script>
            function onFileSelected(input) {
                console.log(1);
                const file = input.files[0];
                // ファイルのアップロードをキャッチ
                const reader = new FileReader();
                reader.onload = onFileLoaded;

                reader.readAsDataURL(file);
            }

            function onFileLoaded(e) {
                console.log(2);
                const src_data = e.target.result;

                const img = new Image();

                img.onload = onImageSetted;
                img.src = src_data;
            }

            function onImageSetted(e) {
                console.log(3);
                const data = createImageData(e.target);

                document.getElementById("test_canvas").getContext("2d").putImageData(data, 0, 0);
            }

            function createImageData(img) {
                console.log(4);
                const ca = document.createElement("canvas");

                ca.width = img.naturalWidth;
                ca.height = img.naturalHeight;

                const ct = ca.getContext("2d");

                ct.drawImage(img, 0, 0);

                var data = ct.getImageData(0, 0, ca.width, ca.height);
                const qrObj = jsQR(data.data, ca.width, ca.height);
                const qrData = qrObj.data;
                console.log(qrData);

                return data;
            }
        </script>

        <input type="file" onchange="onFileSelected(this)" />
        <br />
        <canvas id="test_canvas" width="256" height="256" style="border: 1px solid"></canvas>
    </body>
</html>
