<!DOCTYPE html>

<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

        <script type="text/javascript" src="../lib/jquery.min.js"></script>
        <script type="text/javascript" src="../lib/osql.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

        <script>
            osql.requireLogin();

            // フォーム内容をUser_Sheetに登録させる
            $(document).ready(function () {
                setUserId(); // useridをテキストフィールドに入力
                setCheckedRadio(osql.getParam("state")); // radioボタンをデフォルトで選択状態にする
                setAttendedSheetId(osql.getParam("sheet"));
            });

            // sheet_idのデフォルト値として直近の出席した席を入力
            function setAttendedSheetId(sheetId) {
                if (sheetId) {
                    document.getElementById("sheet_id").value = sheetId;
                    document.getElementById("sheet_id").setAttribute("readonly", "");
                }
            }
            // radioボタンをデフォルトで選択状態にする
            function setCheckedRadio(state) {
                if (state == "leave") {
                    document.getElementById("leave").setAttribute("checked", "");
                } else {
                    document.getElementById("attend").setAttribute("checked", "");
                }
            }
            // useridをテキストフィールドに入力
            function setUserId() {
                const userId = sessionStorage.getItem("userid");
                document.getElementById("user_id").value = userId;
                document.getElementById("user_id").setAttribute("readonly", "");
            }

            // User_Sheetに登録する
            async function insertUser_Sheet() {
                const userId = Number(document.getElementById("user_id").value);
                const sheetId = Number(document.getElementById("sheet_id").value);
                //出席時の登録はis_attend=1, 退席時の登録はis_attend=0とする
                const sql = `insert into User_Sheet (user_id, sheet_id, created_at, is_attend) values(${userId}, ${sheetId}, now(), 1);`;
                await osql.connect(sql);
                console.log(sql);

                document.getElementById("result").innerHTML = "OK";
                location.href = "../usertop.html";
            }

            function button1Pressed() {
                insertUser_Sheet(); // User_Sheetに登録する
            }
            function onFileSelected(input) {
                console.log(1);
                const file = input.files[0];
                // ファイルのアップロードをキャッチ
                const reader = new FileReader();
                reader.onload = onFileLoaded;
                reader.readAsDataURL(file);
            }

            function onFileLoaded(e) {
                console.log(2);
                const src_data = e.target.result;

                const img = new Image();
                img.onload = onImageSet;
                img.src = src_data;
            }

            function onImageSet(e) {
                console.log(3);
                const data = getQRData(e.target);
                if (!data) {
                    alert("QRコードが読み取れませんでした。");
                } else {
                    // フォームに入力
                    document.getElementById("sheet_id").value = data;
                }
            }

            function getQRObject(imageData, canvas) {
                let qrObj = jsQR(imageData.data, canvas.width, canvas.height);

                if (qrObj) {
                    console.log(qrObj.data);
                } else {
                    console.log(qrObj);
                    qrObj = {};
                    qrObj.data = null;
                }

                return qrObj;
            }

            function getQRData(img) {
                // 非表示のjs上でしか利用しないcanvas要素
                const canvasInvisible = document.createElement("canvas");

                canvasInvisible.width = img.naturalWidth;
                canvasInvisible.height = img.naturalHeight;

                // canvasにdrawImageしてそこからimageDataオブジェクトを取得
                const ctx = canvasInvisible.getContext("2d");
                ctx.drawImage(img, 0, 0);
                const imageData = ctx.getImageData(0, 0, canvasInvisible.width, canvasInvisible.height);

                // QRコードのオブジェクトを取得
                const qrObj = getQRObject(imageData, canvasInvisible);

                // QRの表示 scaleメソッドを使うために表示用じゃないcanvasにputImageDataして、表示用canvasにdrawImageする
                ctx.putImageData(imageData, 0, 0);
                const canvas = document.getElementById("imagePreview").getContext("2d");
                canvas.clearRect(0, 0, 1000, 1000); // canvasの初期化 前画像の削除

                // putImageDataした画像サイズからhtmlのcanvas要素のwidth,heightにリサイズして表示
                const hScale = 112 / canvasInvisible.height;
                const wScale = hScale;
                canvas.scale(wScale, hScale);
                canvas.drawImage(canvasInvisible, 0, 0);
                canvas.scale(1 / wScale, 1 / hScale); // scaleのリセット

                return qrObj.data;
            }
        </script>
    </head>

    <body>
        <h1>出席登録</h1>
        <br />
        <canvas id="imagePreview" width="112" height="112" style="border: 1px solid"></canvas>
        <br />
        <input type="file" onchange="onFileSelected(this)" />
        <br />
        <br />
        user id:<input id="user_id" value="" type="textfield" />
        <br />
        座席のid:<input id="sheet_id" value="" type="textfield" />
        <br />
        <label for="attend"><input id="attend" name="q1" type="radio" value="1" />出席</label>　
        <label for="leave"><input id="leave" name="q1" type="radio" value="0" />退席</label>
        <br />
        <button onclick="button1Pressed()">登録</button>
        <br />
        <a id="usertopLink" href="../usertop.html">トップへ戻る</a>
        <p id="result"></p>
    </body>
</html>
